<?xml version="1.0" encoding="UTF-8"?>
<div xmlns="http://www.w3.org/1999/xhtml" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:tei="http://www.tei-c.org/ns/1.0" xmlns:bf="http://betterform.sourceforge.net/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xf="http://www.w3.org/2002/xforms" bf:evalAVTs="src" data-template="templates:surround" data-template-at="content" data-template-with="templates/page.html">
    <xf:model id="model1" style="display:none;">

        <xf:instance id="stdSigns" resource="exist:/db/apps/cuneidb/data/etc/stdSigns/stdSigns.xml"/>

        <xf:submission id="saveStdSigns" method="put" ref="instance('stdSigns')" replace="instance">
            <xf:resource value="'exist:/db/apps/cuneidb/data/etc/stdSigns/stdSigns.xml'"/>
            <xf:message level="ephemeral" ev:event="xforms-submit-done">stored signs</xf:message>
            
            <!-- reset sign list -->
            <xf:action ev:event="xforms-submit-done">
                <xf:delete ref="instance('listSort')/*"/>
                <xf:insert context="instance('listSort')" origin="instance('stdSigns')//tei:char" ev:event="xforms-submit-done"/>
            </xf:action>
            
            <xf:message level="ephemeral" ev:event="xforms-submit-error">an error occured storing signs</xf:message>
        </xf:submission>


        <!-- a generic way to remove resources -->
        <xf:instance id="resourceToBeDeleted">
            <data/>
        </xf:instance>

        <xf:submission id="remove" method="delete">
            <xf:resource resource="concat('exist:/db/apps/cuneidb/data/',instance('resourceToBeDeleted')))"/>
        </xf:submission>


        <!-- template for new signs -->
        <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="charTemplate">
            <char n="[Borger no]" xml:id="id">
                <charName>[sign name]</charName>
                <figure>
                    <graphic url="img"/>
                </figure>
            </char>
        </xf:instance>



        <!-- Standard Sign Form Images -->
        <xf:bind ref="instance('stdSignImg')/path" type="xs:anyURI"/>

        <xf:instance xmlns="" id="stdSignImg">
            <img filename="" id="" mediatype="">
                <path/>
                <message/>
            </img>
        </xf:instance>

        <xf:submission id="storeStdSignImg" method="execute" ref="instance('stdSignImg')" replace="instance" resource="exist:/db/apps/cuneidb/api/storeStdSignImg.xql">
            <xf:message ev:event="xforms-submit-error" level="ephemeral">could not store image</xf:message>
            <!--<xf:message ev:event="xforms-submit-done" level="ephemeral">success</xf:message>-->
            <xf:setvalue ev:event="xforms-submit-done" ref="instance('currentSign')/tei:char/tei:figure/tei:graphic/@url" value="instance('stdSignImg')/path"/>
            <!--<xf:setvalue ev:event="xforms-submit-done" ref="instance('stdSignImg')/path" value="''"/>
            <xf:setvalue ev:event="xforms-submit-done" ref="instance('stdSignImg')/@*" value="''"/>-->
        </xf:submission>


        <!-- Sorting and Filtering -->
        <xf:submission id="sortInstance" method="execute" ref="instance('listSort')" replace="instance" resource="exist:/db/apps/cuneidb/api/sort.xql">
            <xf:message ev:event="xforms-submit-error" level="ephemeral">sorting failed</xf:message>
        </xf:submission>

        <xf:instance xmlns="" id="listFilter">
            <filterExpression/>
        </xf:instance>

        <xf:instance xmlns="" id="listSort">
            <data by=""/>
        </xf:instance>


        <!-- holds the sign currently being edited -->
        <xf:instance xmlns="" id="currentSign">
            <currentSign/>
        </xf:instance>

        <!-- we want to automatically set the xml:id for new std signs-->
        <xf:bind calculate="concat('sign_',parent::tei:char/@n)" ref="instance('currentSign')/tei:char/@xml:id[. = instance('charTemplate')/@xml:id]"/>




        <!-- must insert name and number -->
        <xf:bind constraint=". != instance('charTemplate')/@n and . != ''" ref="instance('currentSign')/tei:char/@n"/>
        <xf:bind constraint=". != instance('charTemplate')/tei:charName and . != ''" ref="instance('currentSign')/tei:char/tei:charName"/>


        <!-- sorted list with filter applied -->
        <xf:bind id="filteredList" ref="instance('listSort')/tei:char[some $x in (@n,tei:charName) satisfies contains($x,instance('listFilter'))]"/>




        <xf:action ev:event="xforms-ready">
            <!-- copy chars from db into list -->
            <xf:insert context="instance('listSort')" origin="instance('stdSigns')//tei:char"/>
            <xf:message level="ephemeral">form loaded</xf:message>
        </xf:action>
    </xf:model>

    <div class="page-header">
        <h1>Standard Signs</h1>
    </div>

    <div class="row-fluid">
        <div class="span5">

            <xf:group>
                <xf:input incremental="true" ref="instance('listFilter')">
                    <xf:label>Filter list</xf:label>
                </xf:input>

                <xf:select1 id="sortSelect" incremental="true" ref="instance('listSort')/@by">
                    <xf:label>Sort by</xf:label>
                    <xf:item>
                        <xf:label>Sign Number</xf:label>
                        <xf:value>@n</xf:value>
                    </xf:item>
                    <xf:item>
                        <xf:label>Sign Name</xf:label>
                        <xf:value>tei:charName</xf:value>
                    </xf:item>
                    <xf:action ev:event="xforms-value-changed">
                        <xf:send submission="sortInstance"/>
                    </xf:action>
                </xf:select1>
            </xf:group>

            <table class="table">
                <thead>
                    <tr>
                        <th>Sign Number</th>
                        <th>Sign Name</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="lsSigns" xf:repeat-nodeset="instance('listSort')/tei:char[some $x in (@n,tei:charName) satisfies contains($x,instance('listFilter'))]">
                    <tr>
                        <td>
                            <xf:output ref="@n"/>
                        </td>
                        <td>
                            <xf:output ref="tei:charName"/>
                        </td>
                        <td>
                            <xf:group appearance="minimal">
                                <xf:trigger>
                                    <xf:label>edit</xf:label>
                                    <xf:delete context="instance('currentSign')/tei:char"/>
                                    <xf:insert context="instance('currentSign')" origin="instance('stdSigns')//tei:char[some $x in (@n,tei:charName) satisfies contains($x,instance('listFilter'))][index('lsSigns')]"/>
                                </xf:trigger>

                                <xf:trigger>
                                    <xf:label>remove</xf:label>
                                    <xf:delete ref="instance('stdSigns')//tei:char[@xml:id = context()/@xml:id]"/>
                                    <xf:delete ref="context()"/>
                                    <xf:send submission="saveStdSigns"/>
                                    <!--<xf:setvalue ref="instance('resourceToBeDeleted')" value="concat('')"></xf:setvalue>-->
                                </xf:trigger>
                            </xf:group>
                        </td>
                    </tr>
                </tbody>
            </table>

            <xf:trigger>
                <xf:label>New Sign</xf:label>
                <xf:delete context="instance('currentSign')/tei:char"/>
                <xf:insert context="instance('currentSign')" origin="instance('charTemplate')"/>
                <xf:setfocus control="charNameInput"/>
            </xf:trigger>
        </div>

        <div class="span7">
            <xf:group ref="instance('currentSign')/tei:char">
                <h3>
                    <i>
                        <xf:output ref="tei:charName"/>
                    </i>
                    <xf:output value="concat('(',@n,')')"/>
                </h3>

                <xf:group appearance="bf:verticalTable">
                    <xf:input id="charNameInput" incremental="true" ref="tei:charName">
                        <xf:label>Sign Name</xf:label>
                        <xf:alert>name must be set</xf:alert>
                    </xf:input>
                    <xf:input incremental="true" ref="@n">
                        <xf:label>Borger Number</xf:label>
                        <xf:alert>number must be set</xf:alert>
                    </xf:input>

                    <!--<table>
                        <tbody xf:repeat-nodeset="tei:figure">
                            <tr>-->
                    <xf:group ref="tei:figure/tei:graphic/@url[. != instance('charTemplate')/tei:figure/tei:graphic/@url]">
                        <xf:output mediatype="image/jpg" value="concat('$app-root/data/etc/stdSigns/',.)">
                            <xf:label>Reference Image</xf:label>
                        </xf:output>
                        <xf:trigger>
                            <xf:label>remove image</xf:label>
                        </xf:trigger>
                    </xf:group>

                    <xf:group ref="tei:figure/tei:graphic/@url[. = instance('charTemplate')/tei:figure/tei:graphic/@url or . = '']" relevant="instance('') != instance('charTemplate')/@n">

                        <xf:upload ref="instance('stdSignImg')/path">
                            <xf:label>Upload new image</xf:label>
                            <xf:filename ref="../@filename"/>
                            <xf:mediatype ref="../@mediatype"/>
                            <xf:action ev:event="xforms-value-changed">
                                <xf:setvalue ref="../@id" value="instance('currentSign')/tei:char/@xml:id"/>
                                <xf:send submission="storeStdSignImg"/>
                            </xf:action>
                        </xf:upload>
                    </xf:group>

                    <!--</tr>
                        </tbody>
                    </table>-->
                </xf:group>

                <xf:group appearance="minimal" id="tabletEditButtons">
                    <xf:trigger>
                        <xf:label>store</xf:label>
                        <xf:action>
                            <!-- remove the char in the TEI file -->
                            <xf:delete if="instance('stdSigns')//tei:char[@xml:id = instance('currentSign')/@xml:id]" ref="instance('stdSigns')//tei:char[@xml:id = instance('currentSign'))/@xml:id]"/>
                            <!-- ... and insert it anew -->
                            <xf:insert context="instance('stdSigns')//tei:charDecl" origin="instance('currentSign')/tei:char"/>
                            <xf:send submission="saveStdSigns"/>
                        </xf:action>
                    </xf:trigger>
                    <xf:trigger>
                        <xf:label>revert</xf:label>
                        <xf:delete if="not(empty(instance('currentSign')))" ref="instance('currentSign')/*"/>
                        <xf:delete if="not(empty(instance('stdSignImg')))" ref="instance('stdSignImg')/*"/>
                        <xf:delete context="instance('listSort')/*"/>
                        <xf:insert context="instance('listSort')" origin="instance('stdSigns')//tei:char"/>
                    </xf:trigger>
                </xf:group>
            </xf:group>
        </div>
    </div>
</div>